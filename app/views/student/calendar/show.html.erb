<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <h1 class="text-3xl font-bold">Calendar</h1>
    <p class="text-gray-600 mt-1">
      Program: <%= link_to @program.name, student_dashboard_path, class: "text-blue-600 hover:text-blue-800" %>
    </p>
  </div>

  <% if session[:preview_mode] && current_user&.department_admin_for?(@program.department) %>
    <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded mb-4 flex items-center justify-between">
      <span>You are viewing this program as a student.</span>
      <%= link_to "Back to program admin view",
                  department_program_path(@program.department, @program),
                  class: "text-sm font-semibold text-blue-800 underline hover:text-blue-900" %>
    </div>
  <% end %>

  <% if @program.held_on_dates.present? && @program.held_on_dates.is_a?(Array) && @program.held_on_dates.any? %>
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold mb-2">Program Dates</h2>
      <p class="text-gray-700">
        This program is held on: <strong><%= @program.held_on_dates_list.map { |d| d.strftime('%B %d, %Y') }.join(', ') %></strong>
      </p>
    </div>
  <% end %>

  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
      <div class="flex gap-2 items-center flex-wrap">
        <% if @filter_mode == "date" %>
          <%= link_to "← Previous",
              student_department_program_calendar_path(@department, @program, date: @date - (@view_mode == "single" ? 1.day : 1.week), view: @view_mode, filter: @filter_mode),
              class: "btn-responsive bg-gray-600 text-white rounded hover:bg-gray-700" %>
          <%= link_to "Today",
              student_department_program_calendar_path(@department, @program, date: Date.current, view: @view_mode, filter: @filter_mode),
              class: "btn-responsive bg-blue-600 text-white rounded hover:bg-blue-700" %>
          <%= link_to "Next →",
              student_department_program_calendar_path(@department, @program, date: @date + (@view_mode == "single" ? 1.day : 1.week), view: @view_mode, filter: @filter_mode),
              class: "btn-responsive bg-gray-600 text-white rounded hover:bg-gray-700" %>
          <div class="flex items-center gap-2 ml-2">
            <label for="date-picker" class="text-sm font-medium text-gray-700">Go to date:</label>
            <%= date_field_tag :date_picker, @date, id: "date-picker",
                onchange: "goToDate(this.value)",
                class: "px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
          </div>
        <% end %>
      </div>
      <div class="flex gap-2 flex-wrap">
        <% first_held_on_date = @program.held_on_dates_list.first || Date.current %>
        <%= link_to "Filter by Date",
            student_department_program_calendar_path(@department, @program, date: first_held_on_date, view: "single", filter: "date"),
            class: "btn-responsive bg-green-600 text-white rounded hover:bg-green-700 #{@filter_mode == 'date' ? 'opacity-75 cursor-not-allowed' : ''}" %>
        <%= link_to "Show All Events",
            student_department_program_calendar_path(@department, @program, filter: "all"),
            class: "btn-responsive bg-green-600 text-white rounded hover:bg-green-700 #{@filter_mode == 'all' ? 'opacity-75 cursor-not-allowed' : ''}" %>
        <% if @filter_mode == "date" %>
          <%= link_to "Single Day",
              student_department_program_calendar_path(@department, @program, date: @date, view: "single", filter: @filter_mode),
              class: "btn-responsive bg-purple-600 text-white rounded hover:bg-purple-700 #{@view_mode == 'single' ? 'opacity-75 cursor-not-allowed' : ''}" %>
          <%= link_to "Week View",
              student_department_program_calendar_path(@department, @program, date: @date, view: "multi", filter: @filter_mode),
              class: "btn-responsive bg-purple-600 text-white rounded hover:bg-purple-700 #{@view_mode == 'multi' ? 'opacity-75 cursor-not-allowed' : ''}" %>
        <% end %>
      </div>
    </div>

    <% if @filter_mode == "date" %>
      <h2 class="text-xl font-semibold mb-4">
        <% if @view_mode == "single" %>
          <%= @date.strftime("%B %d, %Y") %>
        <% else %>
          Week of <%= @date.beginning_of_week.strftime("%B %d, %Y") %>
        <% end %>
      </h2>
    <% else %>
      <h2 class="text-xl font-semibold mb-4">All Program Events</h2>
    <% end %>
  </div>

  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Calendar Events</h2>
    <% if @calendar_events.any? %>
      <ul class="divide-y divide-gray-200">
        <% @calendar_events.each do |event| %>
          <li class="py-2">
            <div class="flex items-start gap-2">
              <div class="flex-shrink-0 w-20 text-xs text-gray-500 pt-0.5">
                <%= event.start_time.strftime("%I:%M %p") %> - <%= event.end_time.strftime("%I:%M %p") %>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <h3 class="font-semibold text-sm"><%= event.title %></h3>
                  <% if event.mandatory? %>
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                      Mandatory
                    </span>
                  <% end %>
                </div>
                <% if event.description.present? %>
                  <div class="mt-1 text-xs text-gray-600 line-clamp-2">
                    <%= truncate(event.description.to_plain_text, length: 100) %>
                  </div>
                <% end %>
                <div class="mt-1 flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600">
                  <% if event.location.present? %>
                    <% location_text = event.location.to_plain_text.strip %>
                    <% if location_text.present? %>
                      <% google_maps_url = "https://www.google.com/maps/search/?api=1&query=#{CGI.escape(location_text)}" %>
                      <span class="flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span class="truncate max-w-xs"><%= truncate(location_text, length: 40) %></span>
                        <a href="<%= google_maps_url %>" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">
                          Directions
                        </a>
                      </span>
                    <% end %>
                  <% end %>
                  <% if event.notes.present? %>
                    <span class="flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                      </svg>
                      <%= truncate(event.notes.to_plain_text, length: 50) %>
                    </span>
                  <% end %>
                  <% if event.participating_faculty.any? %>
                    <span class="text-gray-500">
                      With: <%= event.participating_faculty.map(&:display_name).join(", ") %>
                    </span>
                  <% end %>
                </div>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-gray-500">No calendar events scheduled.</p>
    <% end %>
  </div>

  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-xl font-semibold mb-4">My Appointments</h2>
    <% if @my_appointments.any? %>
      <ul class="divide-y divide-gray-200">
        <% @my_appointments.each do |appointment| %>
          <li class="py-4">
            <h3 class="font-semibold"><%= appointment.vip.display_name %></h3>
            <p class="text-sm text-gray-500">
              <%= appointment.start_time.strftime("%B %d, %Y at %I:%M %p") %> -
              <%= appointment.end_time.strftime("%I:%M %p") %>
            </p>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-gray-500">No appointments scheduled.</p>
    <% end %>
  </div>

  <%= render 'student/navigation', show_dashboard_link: true %>
</div>

<script>
  function goToDate(dateValue) {
    if (dateValue) {
      const baseUrl = '<%= student_department_program_calendar_path(@department, @program) %>';
      const params = new URLSearchParams({
        filter: 'date',
        view: '<%= @view_mode || "single" %>',
        date: dateValue
      });
      window.location.href = baseUrl + '?' + params.toString();
    }
  }
</script>
